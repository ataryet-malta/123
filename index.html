<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>PS4 Malta Save Manager v2.0 - Fully Integrated</title>
    <style>
        body {
            background-color: #0d1117;
            color: #58a6ff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #console-container {
            width: 85%;
            height: 65%;
            background-color: #010409;
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 25px rgba(88, 166, 255, 0.2);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #status-box {
            flex-grow: 1;
            font-size: 14px;
            line-height: 1.6;
        }

        .log-entry { margin-bottom: 5px; border-bottom: 1px dashed #21262d; padding-bottom: 2px; }
        .log-success { color: #3fb950; font-weight: bold; }
        .log-error { color: #f85149; background: rgba(248, 81, 73, 0.1); }
        .log-info { color: #d2a8ff; }
        .log-warn { color: #e3b341; }

        .btn-container { display: flex; gap: 15px; margin-top: 20px; }

        button {
            background-color: #238636;
            color: #ffffff;
            border: 1px solid rgba(240, 246, 252, 0.1);
            padding: 15px 35px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover { background-color: #2ea043; transform: translateY(-2px); }
        button:disabled { background-color: #1b4721; color: #8b949e; cursor: not-allowed; transform: none; }

        .header { margin-bottom: 15px; text-align: center; }
        .header h1 { color: #c9d1d9; font-size: 26px; margin: 0; letter-spacing: 1px; }
        .header p { color: #8b949e; font-size: 13px; margin-top: 5px; }

        /* Scrollbar Styling */
        #console-container::-webkit-scrollbar { width: 8px; }
        #console-container::-webkit-scrollbar-track { background: #010409; }
        #console-container::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
    </style>
</head>
<body>

<div class="header">
    <h1>Ù†Ø¸Ø§Ù… Ù…Ø²Ø§Ù…Ù†Ø© ØªØ®Ø²ÙŠÙ†Ø§Øª Ù…Ø§Ù„Ø·Ø§ ğŸ®</h1>
    <p>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠ - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø³ØªÙˆØ¯Ø¹ 123</p>
</div>

<div id="console-container">
    <div id="status-box">
        <div class="log-entry log-info">> Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (int64, rop, malloc)...</div>
        <div class="log-entry log-warn">> ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø«ØºØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø¯Ø¡.</div>
    </div>
</div>

<div class="btn-container">
    <button id="startBtn" onclick="runDeployment()">ØªÙØ¹ÙŠÙ„ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
</div>

<script src="int64.js"></script>
<script src="rop.js"></script>
<script src="kexploit.js"></script>
<script src="webkit.js"></script>
<script src="malloc.js"></script>

<script>
    // Ù…Ø±Ø§Ø¬Ø¹Ø© ÙØ§Ø¦Ù‚Ø©: ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø§Ø¯ÙŠ Ù„Ù„Ù…Ø³Ø§Ø±
    async function fileExists(path) {
        try {
            // Ø­Ø¬Ø² Ù…Ø³Ø§Ø­Ø© ØµØºÙŠØ±Ø© Ù„Ù‡ÙŠÙƒÙ„ stat
            let st_ptr = await p.malloc(0x100); 
            // syscall 188 Ù‡Ùˆ stat ÙÙŠ FreeBSD
            let res = await p.syscall(188, path, st_ptr); 
            await p.free(st_ptr);
            return res === 0;
        } catch (e) {
            return false;
        }
    }

    function logStatus(message, type = 'info') {
        const box = document.getElementById('status-box');
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.innerHTML = `[${new Date().toLocaleTimeString()}] > ${message}`;
        box.appendChild(entry);
        
        const container = document.getElementById('console-container');
        container.scrollTop = container.scrollHeight;
    }

    async function runDeployment() {
        if (typeof p === 'undefined' || typeof p.syscall === 'undefined') {
            logStatus("âš ï¸ Ø§Ù„ÙƒØ§Ø¦Ù† 'p' ØºÙŠØ± Ù…Ø¹Ø±Ù. Ù‡Ù„ ÙØ¹Ù„Øª Ø§Ù„Ø«ØºØ±Ø©ØŸ", 'error');
            alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù†ÙˆØ§Ø©. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø«ØºØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.");
            return;
        }

        const btn = document.getElementById('startBtn');
        btn.disabled = true;
        
        try {
            await deployAllMaltaSaves();
        } catch (e) {
            logStatus("ğŸ›‘ ÙØ´Ù„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„: " + e.message, 'error');
        } finally {
            btn.disabled = false;
        }
    }

    async function deployAllMaltaSaves() {
        try {
            logStatus("ğŸš€ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„...", 'success');

            const maltaBaseDir = `/data/malta/games-saves/`;
            const userBaseDir = `/user/home/`;
            
            logStatus("ğŸ” Ù…Ø³Ø­ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø§Ø¯ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...");
            let targetUserID = "";
            let userFolders = await p.syscall(202, userBaseDir); 

            for (let folder of userFolders) {
                if (folder === "." || folder === ".." || folder === "0" || folder === "common") continue;
                
                let checkPath = `${userBaseDir}${folder}/malta1`;
                if (await fileExists(checkPath)) {
                    targetUserID = folder;
                    logStatus(`âœ… Ø§ÙƒØªØ´Ø§Ù Ø¨ØµÙ…Ø© Ù…Ø§Ù„Ø·Ø§ ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${folder}`, 'success');
                    break;
                }
            }

            if (targetUserID === "") {
                throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© 'malta1' ÙÙŠ Ø£ÙŠ Ù…Ø³Ø§Ø±.");
            }

            let gameFolders = await p.syscall(202, maltaBaseDir);
            let gamesCount = 0;

            for (let gameCUSA of gameFolders) {
                if (gameCUSA === "." || gameCUSA === ".." || gameCUSA === ".DS_Store") continue;
                
                logStatus(`ğŸ® Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©: ${gameCUSA}`, 'info');
                const sourceDir = `${maltaBaseDir}${gameCUSA}/`;
                const targetPath = `${userBaseDir}${targetUserID}/savedata/${gameCUSA}/`;

                if (await fileExists(targetPath)) {
                    logStatus(`ğŸ§¹ ØªØ·Ù‡ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø±: ${gameCUSA}`);
                    await clearDirectory(targetPath);
                } else {
                    logStatus(`ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${gameCUSA}...`);
                    await p.syscall(136, targetPath, 0o777); 
                }

                let filesInGame = await p.syscall(202, sourceDir);
                for (let fileName of filesInGame) {
                    if (fileName === "." || fileName === "..") continue;
                    
                    let src = sourceDir + fileName;
                    let dest = targetPath + fileName;
                    
                    logStatus(`ğŸ“¤ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø¨Ø§ÙŠØªØ§Øª: ${fileName}`);
                    await copyFileHighLevel(src, dest);
                }
                gamesCount++;
                logStatus(`âœ¨ ØªÙ… Ø­Ù‚Ù† Ø¨ÙŠØ§Ù†Ø§Øª ${gameCUSA} Ø¨Ù†Ø¬Ø§Ø­.`, 'success');
            }

            logStatus(`ğŸŠ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§ÙƒØªÙ…Ù„Øª. Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©: ${gamesCount}`, 'success');
            alert(`Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!\nØ§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: ${targetUserID}\nØ¹Ø¯Ø¯ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨: ${gamesCount}`);

        } catch (error) {
            logStatus(`âŒ Ø®Ø·Ø£ ÙØ§Ø¯Ø­: ${error.message}`, 'error');
        }
    }

    async function clearDirectory(path) {
        let files = await p.syscall(202, path);
        for (let file of files) {
            if (file === "." || file === "..") continue;
            await p.syscall(10, path + file); 
        }
    }

    async function copyFileHighLevel(src, dest) {
        let fd_src = await p.syscall(5, src, 0, 0); 
        if (fd_src < 0) return;

        let fd_dest = await p.syscall(5, dest, 601, 0o777); 
        
        let stat_ptr = await p.malloc(0x100);
        await p.syscall(188, src, stat_ptr); 
        let size = p.read8(stat_ptr.add32(0x48)); // Ù‚Ø±Ø§Ø¡Ø© Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ù‡ÙŠÙƒÙ„ stat
        await p.free(stat_ptr);
        
        let buffer = await p.malloc(size);
        await p.syscall(3, fd_src, buffer, size); 
        await p.syscall(4, fd_dest, buffer, size); 
        
        await p.syscall(6, fd_src);
        await p.syscall(6, fd_dest);
        await p.free(buffer);
    }
</script>

</body>
</html>
